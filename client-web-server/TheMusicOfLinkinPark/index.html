<!DOCTYPE html>
<html>
    <head>
        <title>The Music Of Linkin Park Web Concert</title>
        <style>
            /* canvas { width: 600; height: 300 } */
            body { 
                margin: 0;
                overflow: hidden;
            }
            #welcome-text {
                text-align: center; 
                position: fixed; 
                z-index: 10; 
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 50%;
            }
        </style>
        <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    </head>
    <body>
        <canvas id="canvas"></canvas>
        <h1 id="welcome-text"> The Music of Linkin Pak Web Concert, ask your friends for the URL now!</h1>
        <input type="text" value="..." />
        <script>
            
            let roomId = null;
            // Initialize room Id if present
            try {
                let url = window.location.search;
                console.log("URL RECEIVED: " + url);
                let getQuery = url.split('?')[1];
                let pair = getQuery.split('=');
                
                if(pair[0] === "RoomId" && typeof pair[1] === "string") {
                    roomId = pair[1];
                    document.getElementById("welcome-text").innerHTML = "Establishing Connection to Web Concert...";
                }
            } catch (error) {
                throw new Error("Invalid dataJson: " + dataJson);
            }

            const peer = new Peer();
            peer.on('open', function(id) {
                console.log("Connected: " + peer.id);
                
                try {
                    const conn = peer.connect(roomId);
                    conn.on('open', function() {
                        document.getElementById("welcome-text").innerHTML = "Web Concert Connectd: Enter Your Name and Click anywhere to Start!";
                        // Send messages
                        // conn.send('get-info');
                    });
                    conn.on('data', function(data) {
                        // Receive messages
                        console.log('Received', data);
                        let dataJson = JSON.parse(data);

                        if(dataJson["active"] === false) {
                            document.getElementById("welcome-text").innerHTML = "Waiting for HOST To Start Web Concert";
                        } else if (dataJson["active"] === true) {
                            Object.defineProperty( window, "isConcertRunningFromHostSide", {
                                value: true,
                                writable: false,
                                enumerable: true,
                                configurable: true
                            }); // Makes obj.<key> unwritable and final
                        } else {
                            throw new Error("Invalid dataJson: " + dataJson);
                        }
                    });
                } catch (error) {
                    console.log(error);
                }
            });

        </script>
    </body>
    
    <script src="./index.js"></script>
</html>